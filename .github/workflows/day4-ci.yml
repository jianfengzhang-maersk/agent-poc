name: Day4 - CI

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  ci:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - run: echo "Run tests here (uv sync + pytest)"

  release:
    needs: ci
    runs-on: ubuntu-latest

    # 关键点：只允许 main 分支
    if: github.ref == 'refs/heads/main'

    # 关键点：发布 job 才开写权限（最小权限）
    permissions:
      contents: write

    # 关键点：绑定环境（可以在 GitHub UI 配审批）
    environment: prod

    steps:
      - uses: actions/checkout@v4

      - name: Create a tag (demo)
        run: |
          echo "Here you would create release artifacts/tags"
          echo "This job has write permission to repo contents"
